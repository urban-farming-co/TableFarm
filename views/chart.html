<!DOCTYPE html>
<html>
    <head>
        <title> <%= title %></title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
        <link rel="stylesheet" type="text/css" href="../public/index.css" />
        <link rel="shortcut icon" type="image/x-icon" href='../public/files/flower.ico' />
        <meta charset="utf-8" />
        <script type="text/javascript" src="../scripts/Chart.js/dist/Chart.bundle.js"></script> 
        <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

        <style>
        canvas{
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }
        #chartjs-tooltip {
            opacity: 1;
            position: absolute;
            background: rgba(0, 0, 0, .7);
            color: white;
            border-radius: 3px;
            -webkit-transition: all .1s ease;
            transition: all .1s ease;
            pointer-events: none;
            -webkit-transform: translate(-50%, 0);
            transform: translate(-50%, 0);
        }

        .chartjs-tooltip-key {
            display: inline-block;
            width: 10px;
            height: 10px;
            margin-right: 10px;
        }
        </style>
    </head>
    <body style="margin:0">

        <form action="" method="post" enctype="multipart/form-data">
            Find data after: 
            <input type="date" name="after">
            Find data before: 
            <input type="date" name="before">
            <input type="submit">
        </form>

        <p> Current values: from <%= after %> to <%=before%> </p>
        If no dates are given, average values for each day will be calculated instead.
        <center>
            <a name="justChart"> </a>
            <div style="position:absolute; width:100%; height:100%">
                <canvas id="myChart"></canvas>
            </div>
        </center>
        <script>
function twoDigits(f){
    return ('0' + f).slice(-2);

}
var minHourDays = <%=labels%>;
var lab = [];
var dates=[];
var d = "";
var m;
for (var mhd in (minHourDays)){
    console.log(mhd);
    d = (`${minHourDays[mhd][1]}-${twoDigits(minHourDays[mhd][2])}-${twoDigits(minHourDays[mhd][3])}` ) ;

    console.log(d);
    m = new Date(d);

    console.log(m);

    dates.push((m).toLocaleDateString());
    lab.push ([
            "Day: "+ minHourDays[mhd][0], 
    ] )
}

var data = {
    labels:  lab ,
    datasets: [
    {
        label: "Temperature",
        fillColor: "rgba(220,220,220,0.2)",
        strokeColor: "rgba(220,220,220,1)",
        pointColor: "rgba(220,220,220,1)",
        pointStrokeColor: "#fff",
        pointHighlightFill: "#fff",
        pointHighlightStroke: "rgba(220,220,220,1)",
        data: [ <%= temp %> ]
    },

    {
        label: "Relative Humidity",
        fillColor: "rgba(100,10,100,0.2)",
        strokeColor: "rgba(100,10,100,1)",
        pointColor: "rgba(100,10,100,1)",
        pointStrokeColor: "#0",
        pointHighlightFill: "#0",
        pointHighlightStroke: "rgba(100,100,100,1)",
        data: [ <%= humi %> ]
    },
    {
        label: "Light Lux Level",
        fillColor: "rgba(100,10,100,0.2)",
        strokeColor: "rgba(100,10,100,1)",
        pointColor: "rgba(100,10,100,1)",
        pointStrokeColor: "#0",
        pointHighlightFill: "#0",
        pointHighlightStroke: "rgba(100,100,100,1)",
        data: [ <%=luxl%> ]
    },
    {
        label: "Soil Moisture",
        fillColor: "rgba(100,10,100,0.2)",
        strokeColor: "rgba(100,10,100,1)",
        pointColor: "rgba(100,10,100,1)",
        pointStrokeColor: "#0",
        pointHighlightFill: "#0",
        pointHighlightStroke: "rgba(100,100,100,1)",
        data: [ <%= soil %> ]
    }
    ]

};

var ctx = document.getElementById("myChart").getContext("2d");
var customTooltips = function(tooltip) {
    // Tooltip Element
    var tooltipEl = document.getElementById('chartjs-tooltip');

    if (!tooltipEl) {
        tooltipEl = document.createElement('div');
        tooltipEl.id = 'chartjs-tooltip';
        tooltipEl.innerHTML = "<table></table>"
            document.body.appendChild(tooltipEl);
    }

    // Hide if no tooltip
    if (tooltip.opacity === 0) {
        tooltipEl.style.opacity = 0;
        return;
    }

    // Set caret Position
    tooltipEl.classList.remove('above', 'below', 'no-transform');
    if (tooltip.yAlign) {
        tooltipEl.classList.add(tooltip.yAlign);
    } else {
        tooltipEl.classList.add('no-transform');
    }

    function getBody(bodyItem) {
        return bodyItem.lines;
    }

    // Set Text
    if (tooltip.body) {
        var titleLines = tooltip.title || [];
        var bodyLines = tooltip.body.map(getBody);

        var innerHtml = '<thead>';
        titleLines.forEach(function(title) {
            var i = parseInt(title.substring(5));
            innerHtml += '<tr><th>' + title + '</th></tr>';
            innerHtml += '<tr><th>' + dates[i] + '</th></tr>';
        });
        innerHtml += '</thead><tbody>';

        bodyLines.forEach(function(body, i) {
            var colors = tooltip.labelColors[i];
            var style = 'background:' + colors.backgroundColor;
            style += '; border-color:' + colors.borderColor;
            style += '; border-width: 2px'; 
            var span = '<span class="chartjs-tooltip-key" style="' + style + '"></span>';
            innerHtml += '<tr><td>' + span + body + '</td></tr>';
        });
        innerHtml += '</tbody>';

        var tableRoot = tooltipEl.querySelector('table');
        tableRoot.innerHTML = innerHtml;
    }

    var position = this._chart.canvas.getBoundingClientRect();

    // Display, position, and set styles for font
    tooltipEl.style.opacity = 1;
    tooltipEl.style.left = position.left + tooltip.caretX + 'px';
    tooltipEl.style.top = position.top + tooltip.caretY + 'px';
    tooltipEl.style.fontFamily = tooltip._fontFamily;
    tooltipEl.style.fontSize = tooltip.fontSize;
    tooltipEl.style.fontStyle = tooltip._fontStyle;
    tooltipEl.style.padding = tooltip.yPadding + 'px ' + tooltip.xPadding + 'px';
};
var myNewChart = new Chart(ctx, {
    type: 'line',
    data: data,
    options:{ 
        tooltips: {
            custom:customTooltips,
            mode: "label",
            position: "nearest",
            enabled:false
        }
    },
    scales: {
        yAxes:[{
            ticks:{
                autoSkip:true,
                beginAtZero:true
            }
        }]
    }
})
        </script>

        <script language="javascript"> 
function totop() { 
    scroll(0,0); 
} 
        </script>
    </body>
</html>
